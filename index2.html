<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Santri Language Violation Form | LAC</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    :root{
      --accent: #2bb673;
      --accent-2: #ff7b5c;
      --text-dark: #111827;
    }
    body { margin:0; font-family:"Poppins",sans-serif; transition: background .25s, color .25s; }
    body.theme-light{ background: linear-gradient(135deg,#f8faff 0%, #eef2f8 100%); color: var(--text-dark); }
    body.theme-dark{ background: linear-gradient(180deg,#0f1115 0%, #14161a 100%); color: #e6eef7; }

    .app-wrap{ display:flex; align-items:center; justify-content:center; padding:36px 16px; }
    .glass-card{ width:100%; max-width:920px; border-radius:18px; overflow:hidden; box-shadow:0 12px 40px rgba(2,6,23,0.5); backdrop-filter: blur(8px) saturate(120%); border:1px solid rgba(255,255,255,0.04); }
    body.theme-light .glass-card{ background: linear-gradient(180deg, rgba(255,255,255,0.93), rgba(255,255,255,0.85)); border-color: rgba(0,0,0,0.06); box-shadow:0 8px 30px rgba(2,6,23,0.06); }
    body.theme-dark .glass-card{ background: rgba(255,255,255,0.02); }

    .glass-header{ padding:22px 26px; display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid rgba(255,255,255,0.03); }
    .glass-title h4{ margin:0; font-family: "DM Mono", monospace; letter-spacing: 0.6px; font-weight:400; }
    .glass-title small{ opacity:.75; font-size:.88rem; }

    .progress-track{ width:220px; height:10px; background: rgba(0,0,0,0.06); border-radius:8px; overflow:hidden; }
    .progress-fill{ height:100%; width:55%; background: linear-gradient(90deg,var(--accent-2),#fff0); box-shadow:0 6px 18px rgba(255,123,92,0.12); }

    .header-controls{ display:flex; gap:12px; align-items:center; }
    .theme-toggle{ display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:10px; cursor:pointer; user-select:none; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.02); }

    .card-body{ padding:28px; }
    label{ font-weight:600; margin-bottom:6px; display:block; font-size:0.95rem; }
    .form-control, .form-select, textarea{ border-radius:10px; border:1px solid rgba(0,0,0,0.06); padding:12px 14px; background:transparent; transition: box-shadow .12s, border-color .12s; }
    body.theme-dark .form-control, body.theme-dark .form-select, body.theme-dark textarea{ border:1px solid rgba(255,255,255,0.06); }
    .form-control:focus, .form-select:focus, textarea:focus{ outline:none; box-shadow: 0 6px 18px rgba(37,99,235,0.08); border-color: rgba(37,99,235,0.6); }

    /* Field(s) of expertise removed (no chip styles) */

    .join-btn{ background: var(--accent); color:#fff; border-radius:10px; padding:12px 14px; font-weight:700; border:none; width:100%; box-shadow: 0 8px 24px rgba(43,182,115,0.12); }
    .join-btn i{ vertical-align:middle; }

    /* Select2 & dropdown responsive fixes */
    /* Ensure select2 dropdown is attached to body and has high z-index */
    .select2-container { width:100% !important; }
    .select2-container--default .select2-selection--single { height:44px; display:flex; align-items:center; padding:6px 10px; border-radius:10px; }
    .select2-container--default .select2-selection--single .select2-selection__rendered { line-height:28px; font-size:0.95rem; }
    .select2-dropdown { z-index: 999999 !important; box-shadow: 0 10px 30px rgba(2,6,23,0.2); border-radius:10px; overflow:hidden; }
    .select2-container--open .select2-dropdown { transition: none !important; } /* we set position manually */

    /* make dropdown not exceed viewport and allow scroll */
    .select2-dropdown.select2-dropdown--below { max-width: 95vw; max-height: 50vh; overflow: auto; }

    /* mobile-friendly options (tap targets) */
    .select2-results__option { padding:10px 12px; font-size:0.95rem; white-space:nowrap; }

    /* small screens */
    @media (max-width: 576px){
      .glass-card{ border-radius: 14px; margin:8px; }
      .card-body{ padding:18px; }
      .progress-track{ width:140px; height:8px; }
      .select2-dropdown { max-height: 60vh; }
    }
  </style>
</head>
<body>
  <div class="app-wrap">
    <div class="glass-card" id="mainCard" role="main">
      <div class="glass-header">
        <div class="glass-title">
          <h4>ðŸ“‹ Santri Language Violation</h4>
          <small>Language Advisory Council â€” Form Pelaporan</small>
        </div>

        <div class="header-controls">
          <div class="progress-track" aria-hidden="true">
            <div class="progress-fill" id="progressFill" style="width:55%"></div>
          </div>

          <div class="theme-toggle" id="themeToggle" title="Toggle dark / light">
            <i class="bi bi-moon-stars-fill" id="themeIcon"></i>
            <span id="themeLabel">Dark</span>
          </div>
        </div>
      </div>

      <div class="card-body">
        <form id="formViolation" novalidate>
          <div class="mb-3">
            <label for="noReg">Registration Number</label>
            <!-- select element -->
            <select id="noReg" class="form-select select2" required>
              <option value="">Loading data...</option>
            </select>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="fullName">Full Name</label>
              <input type="text" id="fullName" class="form-control" readonly />
            </div>
            <div class="col-md-3 mb-3">
              <label for="class">Class</label>
              <input type="text" id="class" class="form-control" readonly />
            </div>
            <div class="col-md-3 mb-3">
              <label for="dorm">Dormitory</label>
              <input type="text" id="dorm" class="form-control" readonly />
            </div>
          </div>

          <div class="mb-3">
            <label for="region">Region</label>
            <input type="text" id="region" class="form-control" readonly />
          </div>

          <div class="mb-3">
            <label for="violation">Violation Description</label>
            <textarea id="violation" class="form-control" rows="4" placeholder="Describe the language violation..." required></textarea>
          </div>

          <div class="mb-3">
            <label for="witness">Witness Name</label>
            <input type="text" id="witness" class="form-control" placeholder="Enter witness name" required />
          </div>

          <div class="form-footer">
            <button type="submit" class="join-btn">
              <i class="bi bi-file-earmark-check-fill me-2"></i> Submit Report
            </button>
          </div>

          <div class="mt-3 text-center">
            <button id="installBtn" class="btn btn-outline-secondary w-100" style="display:none;">
              <i class="bi bi-download"></i> Install App
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // -------- THEME (localStorage) ----------
    const THEME_KEY = 'lac_theme_v1';
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeLabel = document.getElementById('themeLabel');

    function applyTheme(theme){
      if(theme === 'light'){
        body.classList.remove('theme-dark'); body.classList.add('theme-light');
        themeIcon.className = 'bi bi-sun-fill';
        themeLabel.textContent = 'Light';
      } else {
        body.classList.remove('theme-light'); body.classList.add('theme-dark');
        themeIcon.className = 'bi bi-moon-stars-fill';
        themeLabel.textContent = 'Dark';
      }
      try { localStorage.setItem(THEME_KEY, theme); } catch(e) {}
    }

    (function initTheme(){
      let saved = null;
      try { saved = localStorage.getItem(THEME_KEY); } catch(e){}
      if(saved){ applyTheme(saved); }
      else {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
      }
    })();

    themeToggle.addEventListener('click', () => {
      const current = body.classList.contains('theme-dark') ? 'dark' : 'light';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    });

    // -------- PWA INSTALL HANDLING ----------
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
      installBtn.style.display = 'none';
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if(choice.outcome === 'accepted') { console.log('App installed'); }
      deferredPrompt = null;
    });

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('service-worker.js').then(()=> console.log('sw registered')).catch(()=>{/*ignore*/});
    }

    // -------- SELECT2 + RESPONSIVE DROPDOWN FIX ----------
    const API_URL = "https://script.google.com/macros/s/AKfycbyCmLa6918-B9AYPCcnBMiTtTW9cMR66Yy8V3-UD7bIi3dUp3vSRkpPumIARyPSI3i2/exec"; // ganti jika perlu

    $(document).ready(function(){
      // Initialize select2 and attach dropdown to body to avoid clipping
      $('#noReg').select2({
        placeholder: "Search by Reg. No or Name",
        allowClear: true,
        width: '100%',
        dropdownParent: $('body'), // IMPORTANT: attach to body so it won't be clipped
        // improve mobile UX
        minimumResultsForSearch: 10,
      });

      // load options
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          $('#noReg').empty().append('<option value=""></option>');
          data.forEach(s => {
            const opt = $('<option>')
              .val(s.regNo)
              .text(`${s.regNo} - ${s.name}`)
              .attr('data-name', s.name || '')
              .attr('data-class', s.class || '')
              .attr('data-dorm', s.dorm || '')
              .attr('data-region', s.region || '');
            $('#noReg').append(opt);
          });
        })
        .catch(err => {
          console.error(err);
          Swal.fire({ icon:'error', title:'Gagal memuat data', text:'Periksa koneksi / link API.' });
        });

      // fill readonly when selection change
      $('#noReg').on('change', function(){
        const sel = $(this).find(':selected');
        $('#fullName').val(sel.data('name') || '');
        $('#class').val(sel.data('class') || '');
        $('#dorm').val(sel.data('dorm') || '');
        $('#region').val(sel.data('region') || '');
      });

      // reposition dropdown to match the input and stay inside viewport
      let lastOpenSelect = null; // remember which select opened
      function positionSelect2Dropdown($select) {
        const $container = $select.data('select2').$container;
        const $dropdown = $('.select2-container--open .select2-dropdown');
        if($dropdown.length === 0 || !$container || !$container.length) return;

        const rect = $container[0].getBoundingClientRect();
        const viewportW = window.innerWidth || document.documentElement.clientWidth;
        const viewportH = window.innerHeight || document.documentElement.clientHeight;

        // desired width = input width but not exceed viewport (keep small margins)
        let desiredWidth = Math.min(rect.width, viewportW - 32);
        let left = rect.left;
        if (left + desiredWidth > viewportW - 8) left = Math.max(8, viewportW - desiredWidth - 8);

        // compute available space
        const spaceBelow = viewportH - (rect.top + rect.height);
        const spaceAbove = rect.top;

        // actual dropdown height (may be 0 initially) -> read scrollHeight as fallback
        let ddHeight = $dropdown.outerHeight();
        if (!ddHeight || ddHeight < 10) ddHeight = Math.min(320, Math.max(120, Math.floor(viewportH * 0.45)));

        let top;
        if (spaceBelow > ddHeight + 12 || spaceBelow > spaceAbove) {
          // place below
          top = rect.top + rect.height + window.scrollY + 6;
          // limit max-height to available below space
          $dropdown.css('max-height', Math.max(120, Math.min(ddHeight, spaceBelow - 16)) + 'px');
        } else {
          // place above
          top = rect.top + window.scrollY - ddHeight - 6;
          if (top < 8) top = 8;
          // limit max-height to available above space
          $dropdown.css('max-height', Math.max(120, Math.min(ddHeight, spaceAbove - 16)) + 'px');
        }

        $dropdown.css({
          position: 'absolute',
          left: left + window.scrollX + 'px',
          top: top + 'px',
          width: desiredWidth + 'px',
          'max-width': '95vw',
          'z-index': 999999
        });
      }

      // reposition when select2 opens
      $('#noReg').on('select2:open', function(){
        lastOpenSelect = $(this);
        // small timeout to ensure dropdown is in DOM and measured
        setTimeout(() => positionSelect2Dropdown($(this)), 10);
      });

      // also reposition on window resize and scroll while dropdown open
      $(window).on('resize scroll', function(){
        if($('.select2-container--open').length && lastOpenSelect) {
          positionSelect2Dropdown(lastOpenSelect);
        }
      });

      // make sure tap on mobile closes dropdown properly
      $(document).on('click touchstart', function(e){
        const $open = $('.select2-container--open');
        if(!$open.length) return;
        const $dropdown = $('.select2-container--open .select2-dropdown');
        const $container = $open.closest('.select2-container');
        if( $(e.target).closest($dropdown).length === 0 && $(e.target).closest($container).length === 0 ){
          // click outside -> close
          $($open).prev('select').select2('close');
        }
      });

      // ---------- FORM SUBMIT ----------
      $('#formViolation').on('submit', function(e){
        e.preventDefault();
        const payload = {
          regNo: $('#noReg').val(),
          name: $('#fullName').val(),
          class: $('#class').val(),
          dorm: $('#dorm').val(),
          region: $('#region').val(),
          violation: $('#violation').val(),
          witness: $('#witness').val()
        };

        if(!payload.regNo){
          Swal.fire('Oops!', 'Please select a student first.', 'warning'); return;
        }
        if(!payload.violation || !payload.witness){
          Swal.fire('Oops!', 'Please complete the required fields.', 'warning'); return;
        }

        Swal.fire({ title: 'Submitting...', text: 'Please wait while we save your report.', allowOutsideClick:false, didOpen: ()=> Swal.showLoading() });

        fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(res => res.text())
        .then(() => {
          Swal.fire({ icon:'success', title:'Report Submitted!', text:'The violation has been recorded successfully.' });
          $('#formViolation')[0].reset();
          $('#noReg').val('').trigger('change');
        })
        .catch(err => {
          console.error(err);
          Swal.fire({ icon:'error', title:'Submission Failed', text:'Please try again later.' });
        });
      });

    }); // ready
  </script>
</body>
</html>
