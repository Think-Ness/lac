<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LAC Admin Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }
    .sidebar {
      height: 100vh;
      background: linear-gradient(180deg, #0d6efd, #003cbe);
      color: white;
      position: fixed;
      padding-top: 1rem;
    }
    .sidebar a {
      color: #dce4ff;
      text-decoration: none;
      display: block;
      padding: 10px 20px;
      border-radius: 8px;
      margin: 4px 8px;
      transition: all 0.2s;
    }
    .sidebar a:hover, .sidebar a.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
    }
    .content {
      margin-left: 250px;
      padding: 2rem;
    }
    .card {
      border: none;
      border-radius: 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    table th {
      background-color: #f1f5ff;
    }
    /* responsive chart in modal + modal sizing (centered, not fullscreen on mobile) */
    .modal-dialog { max-width: 720px; }
    .modal-content { border-radius: 0.8rem; }
    .modal-body { overflow: hidden; } /* avoid modal internal scroll ‚Äî canvas will fit */
    .modal-body canvas { width: 100% !important; height: 260px !important; display:block; }
    @media (max-width: 576px) {
      .modal-dialog { max-width: 94%; } /* small, centered modal on phones */
      .modal-body canvas { height: 300px !important; }
    }

    @media (max-width: 992px) {
      .sidebar { display: none !important; }
      .content { margin-left: 0; padding: 1rem; }
    }
  </style>
</head>
<body>
  <!-- Navbar Mobile -->
  <nav class="navbar navbar-dark bg-primary d-lg-none">
    <div class="container-fluid">
      <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
        <i class="bi bi-list fs-4"></i>
      </button>
      <span class="navbar-brand ms-2 fw-bold">LAC Admin</span>
    </div>
  </nav>

  <div class="d-flex">
    <!-- Sidebar (Desktop) -->
    <div class="sidebar p-3 d-none d-lg-block" style="width:250px;">
      <h4 class="mb-4 text-center fw-bold">LAC Admin</h4>
      <a href="#" id="menuDashboard" class="active"><i class="bi bi-speedometer2"></i> Dashboard</a>
      <a href="#" id="menuStudents"><i class="bi bi-person-lines-fill"></i> Students</a>
      <a href="#" id="menuReports"><i class="bi bi-journal-text"></i> Reports</a>
    </div>

    <!-- Sidebar (Mobile) -->
    <div class="offcanvas offcanvas-start bg-primary text-white" tabindex="-1" id="mobileSidebar">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title fw-bold">LAC Admin</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <a href="#" id="menuDashboardMobile" class="d-block py-2 text-white text-decoration-none"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="#" id="menuStudentsMobile" class="d-block py-2 text-white text-decoration-none"><i class="bi bi-person-lines-fill"></i> Students</a>
        <a href="#" id="menuReportsMobile" class="d-block py-2 text-white text-decoration-none"><i class="bi bi-journal-text"></i> Reports</a>
      </div>
    </div>

    <!-- Content -->
    <div class="content flex-grow-1">
      <div class="container-fluid">
        <!-- === DASHBOARD VIEW === -->
        <div id="dashboardView">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-primary">Violation Reports Dashboard</h3>
            <button class="btn btn-primary" onclick="loadViolations()"><i class="bi bi-arrow-clockwise"></i> Refresh Data</button>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-3 col-sm-6">
              <div class="card text-center p-3">
                <h6 class="text-muted">Total Violations</h6>
                <h3 id="totalViolations" class="fw-bold text-primary">0</h3>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="card text-center p-3">
                <h6 class="text-muted">Unique Students</h6>
                <h3 id="uniqueStudents" class="fw-bold text-success">0</h3>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="card text-center p-3" role="button" onclick="showRayonStats()">
                <h6 class="text-muted">Top Rayon</h6>
                <h5 id="topRayon" class="fw-bold text-warning">-</h5>
                <small class="text-secondary">(click for details)</small>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="card text-center p-3">
                <h6 class="text-muted">Last Updated</h6>
                <h6 id="lastUpdated" class="text-secondary">‚Äì</h6>
              </div>
            </div>
          </div>

          <!-- === Tabel Pelanggaran === -->
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Violation Records</h5>
                <input type="text" id="searchViolation" class="form-control w-auto" placeholder="Search...">
              </div>
              <div class="table-responsive">
                <table class="table table-bordered align-middle">
                  <thead>
                    <tr class="text-center">
                      <th>No</th><th>Reg No</th><th>Name</th><th>Class</th>
                      <th>Rayon</th><th>Region</th><th>Violation</th><th>Witness</th><th>Date</th>
                    </tr>
                  </thead>
                  <tbody id="violationBody">
                    <tr><td colspan="9" class="text-center text-muted">Loading data...</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>Show
                  <select id="limitViolation" class="form-select d-inline w-auto">
                    <option selected>5</option><option>10</option><option>20</option><option>50</option>
                  </select> entries
                </div>
                <div id="paginationViolation" class="btn-group"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üìä Modal Statistik Rayon -->
  <div class="modal fade" id="rayonModal" tabindex="-1">
    <!-- centered, responsive dialog (not fullscreen) -->
    <div class="modal-dialog modal-lg modal-dialog-centered">
       <div class="modal-content">
         <div class="modal-header">
           <h5 class="modal-title">Rayon Violation Statistics</h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
         </div>
         <div class="modal-body">
           <canvas id="rayonChart" height="120"></canvas>
         </div>
       </div>
     </div>
   </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwt2T3L_N318bhVqE3bn2QwrKUjJJRlJVn5Atd7bTfIUPfeiuikm-OAfGYvbDkHSBm9/exec";
    let violations = [], rayonCount = {};

    async function loadViolations() {
      const body = document.getElementById("violationBody");
      body.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Loading...</td></tr>`;
      try {
        const res = await fetch(`${API_URL}?type=Riwayat`);
        violations = (await res.json()).reverse();
        showViolations();

        document.getElementById("totalViolations").textContent = violations.length;
        document.getElementById("uniqueStudents").textContent = new Set(violations.map(x => x.RegNo)).size;

        rayonCount = {};
        violations.forEach(v => rayonCount[v.Rayon] = (rayonCount[v.Rayon] || 0) + 1);

        const sorted = Object.entries(rayonCount).sort((a,b)=>b[1]-a[1]);
        document.getElementById("topRayon").textContent = sorted[0] ? sorted[0][0] : "-";
        document.getElementById("lastUpdated").textContent = new Date().toLocaleString();
      } catch {
        body.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error loading data ‚ùå</td></tr>`;
      }
    }

    function showViolations() {
      const limit = +document.getElementById("limitViolation").value;
      const keyword = document.getElementById("searchViolation").value.toLowerCase();
      const filtered = violations.filter(v =>
        Object.values(v).some(val => String(val).toLowerCase().includes(keyword))
      );
      const start = 0;
      document.getElementById("violationBody").innerHTML = filtered.slice(start, limit).map((d, i) => `
        <tr><td>${i + 1}</td><td>${d.RegNo}</td><td>${d.Name}</td><td>${d.Class}</td>
        <td>${d.Rayon}</td><td>${d.Region}</td><td>${d.Violation}</td><td>${d.Witness}</td><td>${d.Date}</td></tr>
      `).join('');
    }

    // üß≠ Klik Top Rayon ‚Üí Tampilkan Chart
    let rayonChart;
    function showRayonStats() {
      if (!Object.keys(rayonCount).length) return alert("Data belum dimuat üòÖ");
      const modal = new bootstrap.Modal(document.getElementById("rayonModal"));
      modal.show();

      const ctx = document.getElementById("rayonChart").getContext("2d");
      const labels = Object.keys(rayonCount);
      const data = Object.values(rayonCount);

      if (rayonChart) rayonChart.destroy();
      rayonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Violations',
            data: data,
            backgroundColor: '#0d6efd'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // allow canvas to fill modal-body height
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
      // ensure chart sizes correctly after modal is visible
      const modalEl = document.getElementById("rayonModal");
      const bsModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modalEl.addEventListener('shown.bs.modal', () => { setTimeout(()=> rayonChart.resize(), 50); }, { once: true });
    }

    loadViolations();
  </script>
</body>
</html>
